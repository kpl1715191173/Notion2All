## Notion2All 备份核心 TODO（按优先级）

> 说明：每条任务都标注了涉及的代码路径（相对仓库根目录）。后续修复按优先级从上到下推进。

### P0 正确性

- [ ] 处理块分页，避免内容缺失（has_more/next_cursor）
  - 代码路径：`packages/core/src/notion/api.ts`（`getBlockChildren`）
  - 代码路径：`packages/core/src/notion/services/fetcher.ts`（`fetchBlockChildren`、`fetchFullPageData`）
  - 要点：在 API 层循环调用 `blocks.children.list`，合并所有 `results`；Fetcher 保持上层逻辑不丢页，必要时也做保护。数据库查询如使用到，也需处理分页。

- [ ] 避免重复抓取整棵树的资源映射（减少 API 压力）
  - 代码路径：`packages/core/src/notion/services/coordinator.ts`（`buildResourceMap`、`processPage`）
  - 要点：去掉为构建资源映射而触发的第二次整树递归抓取；在首次 `fullData` 遍历时同时记录资源归属与收集附件。

### P0 缓存设计修复

- [ ] 统一缓存文件读取路径，保证增量机制可用
  - 代码路径：
    - `packages/core/src/notion/services/cache.ts`（`getCachedData` 当前读取 `.cache/.../<id>.json`）
    - `packages/core/src/notion/services/saver.ts`（`savePageData` 将 JSON 写入 `outputDir/<ids>/<id>/<id>.json`）
  - 要点：二选一：
    - A. 修改 `getCachedData` 读取 `saver` 实际保存的路径；或
    - B. 在保存时同步写一份镜像到 `.cache` 目录。

- [ ] 避免在 `shouldUpdate` 中频繁重新加载缓存映射（降低 I/O 与竞态）
  - 代码路径：`packages/core/src/notion/services/cache.ts`（`initCacheMap`、`shouldUpdate`、`saveCacheMap`）
  - 要点：构造时懒加载到内存；引入防抖/批量落盘策略（如定时 flush）。

- [ ] 内容哈希策略收敛，减少误判与额外 I/O
  - 代码路径：`packages/core/src/notion/services/cache.ts`（`calculateContentHash`、`updateCache`、`shouldUpdate`）
  - 要点：优先以 `last_edited_time` + 子页面 `last_edited_time` 汇总判断；或改为仅对轻量结构（id/type/has_children）计算哈希。

### P1 性能与稳定性

- [ ] 抓取并发与速率限制，加入指数退避（含 429/5xx 与抖动）
  - 代码路径：
    - `packages/core/src/notion/services/fetcher.ts`（所有网络调用封装处）
    - `packages/core/src/notion/api.ts`（底层 API 调用）
  - 要点：统一重试/backoff 策略；对多子块抓取使用有界并发（如 p-limit）。

- [ ] 移除硬编码并发数，使用配置项
  - 代码路径：`packages/core/src/notion/services/coordinator.ts`（`batchProcessPages`、`processChildPages`）
  - 要点：将 `3` 改为 `this.config.concurrency ?? 默认值`。

- [ ] `fetchFullPageData` 并发抓取直接子块（受并发上限控制）
  - 代码路径：`packages/core/src/notion/services/fetcher.ts`（`fetchFullPageData`）
  - 要点：对子块列表应用并发队列，显著降低深树延迟。

### P1 下载器增强

- [ ] 支持代理/超时/取消/节流，统一与 API 层网络栈
  - 代码路径：`packages/core/src/notion/services/file-downloader.ts`
  - 要点：
    - 注入与 `NotionApi` 一致的 `agent`/proxy，或改用统一 HTTP 客户端；
    - 增加超时、速率限制与重试；
    - 已存在文件幂等跳过，进度日志按时间节流。

### P1 导出格式对齐（md/obsidian）

- [ ] 接入转换器，除 JSON 外输出目标格式
  - 代码路径：
    - `packages/core/src/transformers/json-to-md.ts`
    - `packages/core/src/transformers/json-to-obsidian.ts`
    - `packages/core/src/notion/services/saver.ts`（或新增导出层）
    - `packages/cli/src/commands/backup.ts`（根据 `config.format` 触发）
  - 要点：保留 JSON 作为缓存/校验，新增 md/obsidian 输出与附件相对路径打通。

### P2 日志一致性

- [ ] 统一使用 `NotionBackupLogger`，移除 `console.error`
  - 代码路径：`packages/core/src/notion/api.ts`（`getPage`/`getDatabase`/`queryDatabase`/`getBlockChildren`）
  - 要点：统一日志层级与缩进风格。

### P2 重复处理与环保护

- [ ] 在协调器中引入 `visitedPageIds`，避免重复处理同页
  - 代码路径：`packages/core/src/notion/services/coordinator.ts`（类级字段与 `processPage` 路径判重）

- [ ] 针对潜在环引用做保护
  - 代码路径：`packages/core/src/notion/services/coordinator.ts`（在进入子页前检查访问链条）

### P2 CLI 清理与一致性

- [ ] `--log-recursive` 实现或移除
  - 代码路径：`packages/cli/src/commands/backup.ts`

- [ ] 合理化 `--test-proxy` 的入口
  - 代码路径：`packages/cli/src/commands/backup.ts`、`packages/cli/src/commands/test-proxy.ts`
  - 要点：保留独立命令，`backup` 中仅提示如何使用。

### P3 测试与基准

- [ ] 单元测试：分页、缓存路径、哈希/时间戳判断、去重
  - 代码路径：新增测试目录，覆盖 `packages/core/src/notion/services/*` 与 `packages/core/src/notion/api.ts`

- [ ] 集成测试：小树/深树/大分页/多根页场景
  - 代码路径：新增 e2e 测试与夹具（mock Notion API）。

- [ ] 监测与基准：记录 API 次数、块数、耗时分布
  - 代码路径：可在 `NotionBackupLogger` 或 CLI 层聚合输出。

---

备注：后续修复建议从 P0 开始（分页 + 缓存路径 + 去重抓取），完成后再推进并发/退避与下载器代理，最后整合导出格式与测试基准。


